<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Offline QR Ticket System</title>

  <link rel="stylesheet" href="style.css" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />

  <!-- Register service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./service-worker.js", { scope: "./" })
          .then(registration => {
            console.log("[SW] Service Worker registered successfully:", registration.scope);

            if (registration.waiting) {
              console.log("[SW] Update waiting - reload to activate");
            }

            setInterval(() => registration.update(), 60000);

            registration.addEventListener("updatefound", () => {
              console.log("[SW] Update found");
              const newWorker = registration.installing;
              newWorker.addEventListener("statechange", () => {
                if (newWorker.state === "installed") {
                  if (navigator.serviceWorker.controller) {
                    console.log("[SW] New version available - reload to update");
                  } else {
                    console.log("[SW] Service worker installed for the first time");
                  }
                }
              });
            });
          })
          .catch(err => {
            console.error("[SW] Registration failed:", err);
            if (err.message && (err.message.includes("HTTPS") || err.message.includes("localhost"))) {
              console.warn("[SW] Service workers require HTTPS or localhost. Please use a local server.");
            }
          });
      });

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        console.log("[SW] Controller changed - reloading page");
        window.location.reload();
      });
    } else {
      console.warn("[SW] Service Workers not supported in this browser");
    }

    let deferredPrompt;
    let installBtn, installPromptContainer, headerInstallBtn, installStatusText;

    document.addEventListener("DOMContentLoaded", () => {
      installBtn = document.getElementById("installBtn");
      installPromptContainer = document.getElementById("installPromptContainer");
      headerInstallBtn = document.getElementById("headerInstallBtn");
      installStatusText = document.getElementById("installStatusText");

      checkPWARequirements();

      if (headerInstallBtn) {
        headerInstallBtn.addEventListener("click", () => {
          if (installBtn) installBtn.click();
        });
      }
    });

    function checkPWARequirements() {
      console.log("[PWA] Checking requirements...");

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
          if (reg && reg.active) {
            console.log("[PWA] Service Worker registered:", reg.scope);
          } else {
            console.warn("[PWA] Service Worker not registered yet");
          }
        });
      }

      const isSecure =
        location.protocol === "https:" ||
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1";

      if (!isSecure) {
        console.error("[PWA] Must be on HTTPS or localhost. Current:", location.href);
        if (installStatusText) {
          installStatusText.textContent = `Requires HTTPS or localhost (currently: ${location.protocol}//${location.hostname})`;
          installStatusText.style.color = "var(--danger)";
        }
        if (installBtn) {
          installBtn.disabled = true;
          installBtn.textContent = "Install (Requires HTTPS)";
        }
      } else {
        console.log("[PWA] Secure context:", location.href);
        if (installStatusText) {
          installStatusText.textContent = "Ready to install. Click when the button appears.";
          installStatusText.style.color = "var(--muted)";
        }
      }

      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
      if (isStandalone) {
        console.log("[PWA] App already installed");
        if (installPromptContainer) {
          installPromptContainer.style.display = "none";
        }
      }
    }

    window.addEventListener("beforeinstallprompt", (e) => {
      console.log("[PWA] beforeinstallprompt event fired");
      e.preventDefault();
      deferredPrompt = e;

      if (installPromptContainer) {
        installPromptContainer.style.display = "block";
      }
      if (headerInstallBtn) {
        headerInstallBtn.style.display = "inline-flex";
      }
      if (installBtn) {
        installBtn.disabled = false;
        installBtn.textContent = "Install App";
      }
      if (installStatusText) {
        installStatusText.textContent = "Ready to install! Click the button above.";
        installStatusText.style.color = "var(--success)";
      }
    });

    document.addEventListener("click", async (e) => {
      if (e.target && e.target.id === "installBtn") {
        console.log("[PWA] Install button clicked");

        if (!deferredPrompt) {
          console.warn("[PWA] No deferred prompt available");
          alert(
            "Install instructions:\n\n" +
            "Chrome/Edge Desktop:\n" +
            "- Click the install icon in the address bar, or\n" +
            "- Menu (...) -> Install \"Offline QR Ticket System\"\n\n" +
            "Chrome Android:\n" +
            "- Menu (...) -> Install app, or\n" +
            "- Menu -> Add to Home screen\n\n" +
            "Safari iOS:\n" +
            "- Share -> Add to Home Screen\n\n" +
            "Note: HTTPS or localhost is required for installation."
          );
          return;
        }

        try {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log("[PWA] User choice:", outcome);

          if (outcome === "accepted") {
            e.target.textContent = "Installed!";
            e.target.disabled = true;
          }
        } catch (err) {
          console.error("[PWA] Error showing prompt:", err);
          alert("Install prompt error. Please use the browser menu to install.");
        }

        deferredPrompt = null;
        if (installPromptContainer) {
          installPromptContainer.style.display = "none";
        }
      }
    });

    window.addEventListener("appinstalled", () => {
      console.log("[PWA] App was installed successfully");
      if (installPromptContainer) {
        installPromptContainer.innerHTML = `
          <label>Install App</label>
          <p class="setting-desc" style="color: var(--success);">App installed successfully!</p>
        `;
      }
      deferredPrompt = null;
    });

    if (window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone) {
      console.log("[PWA] App is already installed (standalone mode)");
      if (installPromptContainer) {
        installPromptContainer.style.display = "none";
      }
    }

    window.addEventListener("load", () => {
      setTimeout(() => {
        console.log("[PWA] Status check:");
        console.log("  - URL:", location.href);
        console.log("  - Protocol:", location.protocol);
        console.log("  - Hostname:", location.hostname);
        console.log("  - Service Worker:", "serviceWorker" in navigator ? "Supported" : "Not supported");
        console.log("  - Standalone:", window.matchMedia("(display-mode: standalone)").matches);
        console.log("  - beforeinstallprompt:", "onbeforeinstallprompt" in window ? "Supported" : "Not supported");
      }, 1000);
    });
  </script>
</head>
<body>
  <header>
    <div class="header-bar">
      <div class="brand">
        <img src="icon-192.png" alt="Offline QR Ticket System logo" class="logo" />
        <div class="brand-text">
          <h1>Offline QR Ticket System</h1>
          <p class="subtitle">Generate &bull; Print &bull; Scan &bull; Track &mdash; fully offline PWA</p>
        </div>
      </div>
      <button id="headerInstallBtn" class="header-install-btn" style="display: none;">
        Install App
      </button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab-btn active" data-tab="generator">Generate</button>
    <button class="tab-btn" data-tab="scanner">Camera</button>
    <button class="tab-btn" data-tab="dashboard">Dashboard</button>
  </nav>

  <main>
    <section id="generator" class="tab-content active">
      <div class="card">
        <h2>Generate Tickets</h2>
        <p class="card-subtitle">Create ticket batches that stay saved offline until you reset them.</p>
        <div class="generate-section">
          <div class="generate-controls">
            <div class="input-group">
              <label for="ticketCount">Number of Tickets</label>
              <input id="ticketCount" type="number" value="20" min="1" max="500" />
            </div>
            <button id="generateBtn" class="primary-btn">Generate Tickets</button>
          </div>

          <div class="action-buttons" aria-label="Print and export options">
            <button id="downloadSheetBtn" class="action-btn">Print Sheet</button>
            <button id="exportBtn" class="action-btn">Export CSV</button>
            <button id="exportJSONBtn" class="action-btn">Export JSON (Sync)</button>
            <button id="importBtn" class="action-btn">Import JSON (Sync)</button>
            <input id="importFile" type="file" accept="application/json" class="hidden" aria-label="Import tickets JSON file" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="tickets-header">
          <h3>Generated Tickets</h3>
          <span class="ticket-count-badge" id="ticketCountBadge">0 tickets</span>
        </div>
        <div id="qrcodes" class="qrcode-grid"></div>
      </div>
    </section>

    <section id="scanner" class="tab-content">
      <div class="card scanner-card">
        <h2>Camera Scanner</h2>
        <p class="card-subtitle">Align the QR code inside the frame and hold steady until the result appears.</p>
        <div class="row scanner-controls">
          <button id="startScannerBtn">Start Scanner</button>
          <button id="stopScannerBtn" disabled>Stop Scanner</button>
        </div>
        <div id="reader" class="reader"></div>
        <div class="scanner-guidance">
          <span class="scanner-icon" aria-hidden="true">ðŸŽ¯</span>
          <div class="scanner-text">
            <p>Hold tickets about 10-15 cm from the camera for a quick focus lock.</p>
            <p class="scan-hint">Tap the feedback banner, or wait for it to close, to scan the next guest.</p>
          </div>
        </div>
        <div id="scanResult" class="scan-result" aria-live="polite"></div>
      </div>

      <div id="scanFeedback" class="scan-feedback hidden">
        <div class="feedback-content">
          <div class="feedback-icon" id="feedbackIcon"></div>
          <div class="feedback-title" id="feedbackTitle"></div>
          <div class="feedback-code" id="feedbackCode"></div>
          <div class="feedback-message" id="feedbackMessage"></div>
          <div class="feedback-hint">Tap anywhere to dismiss and scan another ticket.</div>
        </div>
      </div>
    </section>

    <section id="dashboard" class="tab-content">
      <div class="card">
        <h2>Ticket Dashboard</h2>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="totalTickets">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="usedTickets">0</div>
            <div class="stat-label">Used</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="unusedTickets">0</div>
            <div class="stat-label">Unused</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Settings</h2>
        <div class="settings-group">
          <div class="setting-item" id="installPromptContainer">
            <label>Install App</label>
            <p class="setting-desc">Install this app on your device for quick access and offline use.</p>
            <button id="installBtn" class="primary-btn">Install App</button>
            <p class="setting-desc" id="installStatus" style="margin-top: 8px; font-size: 0.85rem; color: var(--muted);">
              <span id="installStatusText">Waiting for install prompt...</span>
            </p>

            <div class="install-instructions">
              <p class="install-heading">Manual Installation</p>
              <div class="install-steps">
                <p><strong>Chrome Android:</strong></p>
                <p class="install-step">Menu (...) -> Install app, or Menu -> Add to Home screen</p>

                <p><strong>Safari iOS:</strong></p>
                <p class="install-step">Share -> Add to Home Screen</p>

                <p class="install-note">Note: the install prompt requires HTTPS or localhost.</p>
              </div>
            </div>
          </div>

          <div class="setting-item">
            <label>Reset All Tickets</label>
            <p class="setting-desc">Permanently delete all tickets and reset the system.</p>
            <button id="resetBtn" class="danger">Reset All Tickets</button>
          </div>

          <div class="setting-item">
            <label>Export Data</label>
            <p class="setting-desc">Download all tickets as a CSV file for backup.</p>
            <button id="exportSettingsBtn">Export CSV</button>
          </div>

          <div class="setting-item">
            <label>Import Data</label>
            <p class="setting-desc">Restore tickets from a JSON backup file.</p>
            <button id="importSettingsBtn">Import JSON</button>
            <input id="importSettingsFile" type="file" accept="application/json" class="hidden" aria-label="Import tickets JSON file" />
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <small>Tap the install button in your browser to add the app to your home screen. Works offline after the first load.</small>
  </footer>

  <script>
    function loadScriptLocalOrCdn(localPath, cdnUrl) {
      return new Promise((resolve, reject) => {
        fetch(localPath, { method: "HEAD" })
          .then(resp => {
            const script = document.createElement("script");
            script.src = resp.ok ? localPath : cdnUrl;
            script.onload = () => resolve();
            script.onerror = () => reject(new Error("script load failed"));
            document.head.appendChild(script);
          })
          .catch(() => {
            const script = document.createElement("script");
            script.src = cdnUrl;
            script.onload = () => resolve();
            script.onerror = () => reject(new Error("script load failed"));
            document.head.appendChild(script);
          });
      });
    }

    Promise.all([
      loadScriptLocalOrCdn("qrcode.min.js", "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"),
      loadScriptLocalOrCdn("html5-qrcode.min.js", "https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js")
    ])
      .then(() => {
        console.log("Scripts loaded, checking for QRCode...");
        let retryCount = 0;
        const maxRetries = 40;

        const waitForQRCode = () => {
          retryCount += 1;
          if (typeof QRCode !== "undefined") {
            console.log("QRCode found! Loading script.js");
            const script = document.createElement("script");
            script.src = "script.js";
            document.body.appendChild(script);
            return;
          }

          if (retryCount < maxRetries) {
            setTimeout(waitForQRCode, 50);
          } else {
            console.error("QRCode library not found after loading. Loading script.js anyway.");
            const script = document.createElement("script");
            script.src = "script.js";
            document.body.appendChild(script);
          }
        };

        setTimeout(waitForQRCode, 100);
      })
      .catch(err => {
        console.error("Failed to load QR libraries", err);
        const script = document.createElement("script");
        script.src = "script.js";
        document.body.appendChild(script);
      });
  </script>
</body>
</html>
